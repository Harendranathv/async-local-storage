(function(a,b){"use strict";if(void 0!==a.window&&a.window===a&&void 0!==a.indexedDB){var c="async_local_storage",d="als_objects",e=1,f=null,g={};g.tail=new Future(function(a){a.accept()}),g.add=function(a){var b=g.tail,c=function(){return m().then(function(){var b=new Future(function(b){i(a,b)});return new Future(function(a){var c=a.accept.bind(a);b.done(c,c)})})};return g.tail=b.then(c,c)};var k,h=function(a){return a},i=function(a,b){var c=a.operation,e=a.transform||h,g=f.transaction([d],["get","forEach"].indexOf(c)>=0?"readonly":"readwrite"),i=g.objectStore(d),j=null,k=function(a){setTimeout(function(){b.resolve(e(a))},1)},l=function(a){setTimeout(function(){b.reject(a)},1)};switch(c){case"get":j=i.get(a.key);break;case"set":j=i.put(a.value,a.key);break;case"delete":j=i.delete(a.key);break;case"clear":j=i.clear();break;case"has":j=i.count(a.key);break;case"count":j=i.count();break;case"forEach":return j=i.openCursor(),j.onsuccess=function(b){var c=b.target.result;if(c)try{a.callback.call(a.scope||null,c.value,c.key),c.continue()}catch(d){l(d)}else k()},j.onerror=l,void 0}return j?(j.onsuccess=function(){k(j.result)},j.onerror=function(a){console.error(a),l(a)},void 0):(l(Error("IDB Request Failed")),void 0)},j=!1,l=new Future(function(a){k=a}),m=function(){if(j)return l;j=!0;var b=a.indexedDB.open(c,e);return b.onupgradeneeded=function(a){f=a.target.result,f.createObjectStore(d)},b.onsuccess=function(a){f=a.target.result,k.resolve(a)},b.onfailure=k.reject.bind(k),l},n=function(a){return{configurable:!0,enumerable:!1,writable:!1,value:a}};b.storage=Object.create(null,{has:n(function(a){return g.add({operation:"has",key:a,transform:function(a){return!!a}})}),set:n(function(a,b){return g.add({operation:"set",key:a,value:b})}),get:n(function(a){return g.add({operation:"get",key:a})}),"delete":n(function(a){return g.add({operation:"delete",key:a})}),clear:n(function(){return g.add({operation:"clear"})}),count:n(function(){return g.add({operation:"count"})}),forEach:n(function(a,c){return g.add({operation:"forEach",callback:function(c,d){a(c,d,b.storage)},scope:c})})})}})(this,this.navigator||{});
